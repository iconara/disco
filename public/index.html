<!DOCTYPE html>

<html>
  <head>
    <title>Disco</title>
    <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .link {
      stroke: #999;
      stroke-width: 1px;
    }

    .label {
      font-family: Helvetica;
      font-size: 10px;
      fill: #999;
      pointer-events: none;
    }

    .node.focused,
    .link.focused {
      stroke: #444;
      stroke-width: 3px;
    }

    .label.focused {
      fill: #444;
      font-weight: bold;
      font-size: 12px;
    }
    </style>
    <script src="app/lib/d3.v2.min.js"></script>
  </head>
  <body>
    <script>
    var utils = {}

    utils.uniq = function (list) {
      var uniqueList = []
      var lastItem = null
      list.sort().forEach(function (item) {
        if (item != lastItem) {
          uniqueList.push(item)
        }
      })
      return uniqueList
    }

    utils.pluck = function (property) {
      var components = property.split(".")
      return function (obj) {
        var o = obj
        for (var i = 0; i < components.length; i++) {
          o = o[components[i]]
        }
        return o
      }
    }

    // var colors = ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#a65628", "#f781bf"]
    var colors = d3.scale.linear().range(["#e41a1c", "#984ea3"]).interpolate(d3.interpolateHcl)

    var createTopologyManager = function (topology) {
      var self = {}
      var apps = utils.uniq(topology.hosts.map(utils.pluck("app")))
      var nodes = []
      var links = []

      self.nodes = function () { return nodes }
      self.links = function () { return links }
      self.apps = function () { return apps }

      self.randomHost = function () {
        return topology.hosts[Math.floor(Math.random() * topology.hosts.length)]
      }

      var findHost = function (id) {
        for (var i = 0; i < topology.hosts.length; i++) {
          if (topology.hosts[i].id == id) {
            return topology.hosts[i]
          }
        }
        return null
      }

      var findNodeIndex = function (id) {
        for (var i = 0; i < nodes.length; i++) {
          if (nodes[i].id == id) {
            return i
          }
        }
        return -1
      }

      var eachConnection = function (block) {
        topology.connections.forEach(block)
      }

      self.addNode = function (node, connectionsListener) {
        eachConnection(function (connection) {
          var link = {target: -1, source: -1}
          if (connection.target == node.id) {
            link.target = nodes.length
            link.source = findNodeIndex(connection.source)
          } else if (connection.source == node.id) {
            link.target = findNodeIndex(connection.target)
            link.source = nodes.length
          }
          if (link.source != -1 && link.target != -1) {
            links.push(link)
          } else if (link.source != -1) {
            var host = findHost(connection.target)
            if (host != null && connectionsListener != null) {
              connectionsListener(host)
            }
          } else if (link.target != -1) {
            var host = findHost(connection.source)
            if (host != null && connectionsListener != null) {
              connectionsListener(host)
            }
          }
        })
        nodes.push(node)
      }

      return self
    }

    var createTopologyBuilder = function (topologyManager) {
      var self = {}
      var candidates = [topologyManager.randomHost()]

      var isCandidate = function (id) {
        for (var i = 0; i < candidates.length; i++) {
          if (candidates[i].id == id) {
            return true
          }
        }
        return false
      }

      self.addNext = function () {
        if (candidates.length == 0) {
          return false
        }

        var host = candidates.shift()
        var node = {id: host.id, name: host.name, app: host.app}
        topologyManager.addNode(node, function (connectedHost) {
          if (!isCandidate(connectedHost.id)) {
            candidates.push(connectedHost)
          }
        })

        return true
      }

      return self
    }

    var createVisualizationController = function (d3, win, topologyManager) {
      var self = {}
      var svg = null
      var linksGroup = null
      var nodesGroup = null
      var labelsGroup = null
      var forceLayout = null

      win.onresize = resizeUpdate

      var width = function () {
        return win.innerWidth
      }

      var height = function () {
        return win.innerHeight
      }

      self.start = function () {
        svg = d3.select("body").append("svg:svg")
          .attr("width", width())
          .attr("height", height())

        linksGroup = svg.append("svg:g").attr("class", "links")
        nodesGroup = svg.append("svg:g").attr("class", "nodes")
        labelsGroup = svg.append("svg:g").attr("class", "labels")

        forceLayout = d3.layout.force()
          .nodes(topologyManager.nodes())
          .links(topologyManager.links())
          .linkDistance(100)
          .charge(-400)
          .size([width(), height()])
          .on("tick", layoutUpdate)

        self.update()
      }

      var resizeUpdate = function () {
        svg.attr("width", width()).attr("height", height())
        forceLayout.size([width(), height()])
        self.update()
      }

      var layoutUpdate = function () {
        linksGroup.selectAll("line.link")
          .attr("x1", utils.pluck("source.x"))
          .attr("y1", utils.pluck("source.y"))
          .attr("x2", utils.pluck("target.x"))
          .attr("y2", utils.pluck("target.y"))

        nodesGroup.selectAll("circle.node")
          .attr("cx", utils.pluck("x"))
          .attr("cy", utils.pluck("y"))

        labelsGroup.selectAll("text.label")
          .attr("x", utils.pluck("x"))
          .attr("y", utils.pluck("y"))
      }

      var nodeMouseOver = function (d) {
        d3.select(this).classed("focused", true)
        linksGroup.selectAll("line.link").classed("focused", function (dd) {
          return dd.source.id == d.id || dd.target.id == d.id
        })
        labelsGroup.selectAll("text.label").classed("focused", function (dd) {
          return dd.id == d.id
        })
      }

      var nodeMouseOut = function (d) {
        d3.select(this).classed("focused", false)
        linksGroup.selectAll("line.link").classed("focused", false)
        labelsGroup.selectAll("text.label").classed("focused", false)
      }

      self.update = function () {
        linksGroup.selectAll("line.link")
          .data(topologyManager.links(), function (d) { return [d.source.id, d.target.id].join("-") })
          .enter()
          .insert("svg:line", "circle.node")
            .attr("class", "link")

        nodesGroup.selectAll("circle.node")
          .data(topologyManager.nodes(), utils.pluck("id"))
          .enter()
          .insert("svg:circle")
            .attr("class", "node")
            .attr("r", 10)
            .attr("fill", function (d) { return colors(topologyManager.apps().indexOf(d.app)) })
            .on("mouseover", nodeMouseOver)
            .on("mouseout", nodeMouseOut)
            .call(forceLayout.drag)

        labelsGroup.selectAll("text.label")
          .data(topologyManager.nodes(), utils.pluck("id"))
          .enter()
          .insert("svg:text")
            .attr("class", "label")
            .attr("dx", 15)
            .attr("dy", 4)
            .text(utils.pluck("name"))

        forceLayout.size([width(), height()])
        forceLayout.start()
      }

      return self
    }

    d3.json("data/staging.json", function (topology) {
      var topologyManager = createTopologyManager(topology)
      var topologyBuilder = createTopologyBuilder(topologyManager)
      var visualizationController = createVisualizationController(d3, window, topologyManager)

      visualizationController.start()

      var intervalId = setInterval(function () {
        if (topologyBuilder.addNext()) {
          visualizationController.update()
        } else {
          clearInterval(intervalId)
        }
      }, 1000)
    })
    </script>
  </body>
</html>