<!DOCTYPE html>

<html>
  <head>
    <title>Disco</title>
    <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    rect {
      fill: #fff;
    }

    .node {
    }

    .node.focused {
      stroke: #999;
      stroke-width: 3px;
    }

    .link {
      stroke: #999;
      stroke-width: 1px;
    }

    .label {
      font-family: Helvetica;
      font-size: 10px;
      fill: #999;
    }
    </style>
    <script src="app/lib/d3.v2.min.js"></script>
  </head>
  <body>
    <script>
    var uniq = function (list) {
      var uniqueList = []
      var lastItem = null
      list.sort().forEach(function (item) {
        if (item != lastItem) {
          uniqueList.push(item)
        }
      })
      return uniqueList
    }

    var pluck = function (property) {
      var components = property.split(".")
      return function (obj) {
        var o = obj
        for (var i = 0; i < components.length; i++) {
          o = o[components[i]]
        }
        return o
      }
    }

    var width = function () {
      return window.innerWidth
    }

    var height = function () {
      return window.innerHeight
    }

    d3.json("data/staging.json", function (data) {
      var apps = uniq(data.hosts.map(pluck("app")))

      // var colors = ["#e41a1c", "#377eb8", "#4daf4a", "#984ea3", "#ff7f00", "#a65628", "#f781bf"]
      var colors = d3.scale.linear().range(["#e41a1c", "#984ea3"]).interpolate(d3.interpolateHcl)

      var nodes = []
      var links = []

      var vis = d3.select("body")
        .append("svg:svg")
          .attr("width", width())
          .attr("height", height())

      var linksGroup = vis.append("svg:g").attr("class", "links")
      var nodesGroup = vis.append("svg:g").attr("class", "nodes")
      var labelsGroup = vis.append("svg:g").attr("class", "labels")

      var force = d3.layout.force()
          .nodes(nodes)
          .links(links)
          .linkDistance(100)
          .charge(-400)
          .size([width(), height()])

      var findNodeIndex = function (id) {
        for (var i = 0; i < nodes.length; i++) {
          if (nodes[i].id == id) {
            return i
          }
        }
        return -1
      }

      var findHost = function (id) {
        for (var i = 0; i < data.hosts.length; i++) {
          if (data.hosts[i].id == id) {
            return data.hosts[i]
          }
        }
        return null
      }

      var isCandidate = function (id) {
        for (var i = 0; i < candidates.length; i++) {
          if (candidates[i].id == id) {
            return true
          }
        }
        return false
      }

      var candidates = [data.hosts[Math.floor(Math.random() * data.hosts.length)]]

      setTimeout(function () {
        if (candidates.length > 0) {
          var host = candidates.shift()
          var node = {id: host.id, name: host.name, app: host.app}
          data.connections.forEach(function (connection) {
            var link = {target: -1, source: -1}
            if (connection.target == node.id) {
              link.target = nodes.length
              link.source = findNodeIndex(connection.source)
            } else if (connection.source == node.id) {
              link.target = findNodeIndex(connection.target)
              link.source = nodes.length
            }
            if (link.source != -1 && link.target != -1) {
              links.push(link)
            } else if (link.source != -1 && link.target == -1) {
              var host = findHost(connection.target)
              if (host != null && !isCandidate(host.id)) {
                candidates.push(host)
              }
            } else if (link.source == -1 && link.target != -1) {
              var host = findHost(connection.source)
              if (host != null && !isCandidate(host.id)) {
                candidates.push(host)
              }
            }
          })
          nodes.push(node)
          update()
          setTimeout(arguments.callee, 1000)
        }
      }, 1000)

      force.on("tick", function () {
        linksGroup.selectAll("line.link")
            .attr("x1", pluck("source.x"))
            .attr("y1", pluck("source.y"))
            .attr("x2", pluck("target.x"))
            .attr("y2", pluck("target.y"))

        nodesGroup.selectAll("circle.node")
            .attr("cx", pluck("x"))
            .attr("cy", pluck("y"))

        labelsGroup.selectAll("text.label")
            .attr("x", pluck("x"))
            .attr("y", pluck("y"))
      })

      var update = function () {
        linksGroup.selectAll("line.link")
          .data(links, function (d) { return [d.source.id, d.target.id].join("-") })
          .enter()
          .insert("svg:line", "circle.node")
            .attr("class", "link")

        nodesGroup.selectAll("circle.node")
          .data(nodes, pluck("id"))
          .enter()
          .insert("svg:circle")
            .attr("class", "node")
            .attr("r", 5)
            .attr("fill", function (d) { return colors(apps.indexOf(d.app)) })
            .on("mouseover", function (d) { d3.select(this).classed("focused", true) })
            .on("mouseout", function (d) { d3.select(this).classed("focused", false) })
            .call(force.drag)

        labelsGroup.selectAll("text.label")
          .data(nodes, pluck("id"))
          .enter()
          .insert("svg:text")
            .attr("class", "label")
            .attr("dx", 8)
            .attr("dy", 4)
            .text(pluck("name"))

        force.size([width(), height()])
        force.start()
      }

      window.onresize = function () {
        vis.attr("width", width()).attr("height", height())
        force.size([width(), height()])
        update()
      }

      update()
    })
    </script>
  </body>
</html>