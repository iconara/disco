#!/usr/bin/env ruby
# encoding: utf-8

$: << File.expand_path('../../lib', __FILE__)

require 'json'
require 'disco'


instance_cache_path = File.expand_path('../../.instances.json', __FILE__)

abort('Please specify connections file') unless ARGV.first
abort('Please re-run disco to recreate the instance cache') unless File.exists?(instance_cache_path)

instances = Disco::InstanceCache.new(instance_cache_path).instances
connection_filter = Disco::PortFilter.new(1..10_000, 27017, 55672)
renderer = Disco::DotRenderer.new(connection_filter)

connections = JSON.parse(File.read(ARGV.first)).map do |upstream, downstream, port|
  Disco::Connection.new(instance_cache[upstream], instance_cache[downstream], port)
end

renderer.render(connections)

